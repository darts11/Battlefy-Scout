<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Strata by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<div class="inner">
					<a href="#" class="image avatar"><img src="images/avatar.jpg" alt="" /></a>
					<h1><strong>Battlefy Scouting Tool</strong><br />
					created by <a href="https://darts11.github.io/">Christopher Han</a>.</h1>
				</div>
			</header>

		<!-- Main -->
			<div id="main">

				<!-- One -->
					<section id="one">
						<header class="major">
							<h2>Enter the link below:</h2>
						</header>
						<br>
						<form class="form">
							<input type="text" name="battlefylink" placeholder="e.g https://battlefy.com/victoryroad/victory-road-october-challenge/68e3e3c1af568f00460c7f8c/">
							<input type="submit" value="Submit">
						</form>
					</section>

				<!-- Two -->
					<section id="two">
						<script>
							console.log('Script loaded');
							
							// Initialize when DOM is ready or immediately if already ready
							if (document.readyState === 'loading') {
								document.addEventListener('DOMContentLoaded', initializeForm);
							} else {
								initializeForm();
							}
							
							function initializeForm() {
								console.log('Initializing form handler');
								const formEl = document.querySelector('.form');
								
								if (!formEl) {
									console.error('Form element not found');
									return;
								}
								
								console.log('Form found, adding event listener');
								
								formEl.addEventListener('submit', async (event) => {
									console.log('Form submitted');
									event.preventDefault();
									
									const formData = new FormData(formEl);
									let link = formData.get('battlefylink');
									console.log('Link from form:', link);
									
									// Check if link is null or empty
									if (!link || link.trim() === '') {
										alert('Please enter a Battlefy link');
										return;
									}
									
									// Clear the list immediately
									let list = document.getElementById('myList');
									console.log('List element found:', !!list);
									
									if (list) {
										while(list.firstChild) {
											list.removeChild(list.firstChild);
										}
										console.log('List cleared successfully');
									}
									
									// Extract tournament ID
									let splitLink = link.split('/');
									let tourid = "";
									if(splitLink[5] && splitLink[5].length == 24){
										tourid = splitLink[5];
									}
									else{
										for(let i = 0; i < splitLink.length; i++){
											if(splitLink[i] && splitLink[i].length == 24){
												tourid = splitLink[i];
											}
										}
									}
									
									console.log('Tournament ID:', tourid);
									
									let mainurl = "https://api.battlefy.com/tournaments/" + tourid;
									let standing = [];
									
									try{
									const tournamentResponse = await fetch(mainurl);
									const tournamentData = await tournamentResponse.json();
									console.log('Tournament data:', tournamentData);
									console.log('Stage IDs:', tournamentData.stageIDs);
									const [swissID, topcutID] = tournamentData.stageIDs || [];
									console.log('Swiss ID:', swissID, 'TopCut ID:', topcutID);									
									const tcurl = "https://d2jpovtdeeoi3i.cloudfront.net/stages/" + topcutID + "/elimination-standings";
									console.log('TopCut URL:', tcurl);
									const tcResponse = await fetch(tcurl);
									console.log('TopCut response status:', tcResponse.status);
									const tcData = await tcResponse.json();
									console.log('TopCut data:', tcData);
									if (tcData.standings) {
										console.log('TopCut standings found:', tcData.standings.length, 'players');
										console.log('First few TopCut players:', tcData.standings.slice(0, 5));
										tcData.standings.forEach((player, index) => {
											if (player.name) {
												standing.push(player.name);
												console.log(`Added TopCut player ${index + 1}:`, player.name);
											} else {
												console.log(`TopCut player ${index + 1} has no name:`, player);
											}
										});
									} else {
										console.log('No TopCut standings found');
									}									console.log('Standing after TopCut:', standing.length, 'players');

									const swissurl = "https://dtmwra1jsgyb0.cloudfront.net/stages/" + swissID + "/latest-round-standings";
									console.log('Swiss URL:', swissurl);
									const swissRes = await fetch(swissurl);
									console.log('Swiss response status:', swissRes.status);
									const swissData = await swissRes.json();
									console.log('Swiss data:', swissData);

									if (Array.isArray(swissData)) {
										console.log('Swiss standings found (direct array):', swissData.length, 'players');
										swissData.forEach(player => {
											if (player.name && !standing.includes(player.name)) {
												standing.push(player.name);
											}
										});
									} else if (swissData.standings) {
										console.log('Swiss standings found (in standings property):', swissData.standings.length, 'players');
										swissData.standings.forEach(player => {
											if (player.name && !standing.includes(player.name)) {
												standing.push(player.name);
											}
										});
									} else {
										console.log('No Swiss standings found');
									}

									const teamsUrl = "https://api.battlefy.com/tournaments/" + tourid + "/teams";
										const teamsRes = await fetch(teamsUrl);
										const teamsData = await teamsRes.json();
										let nameTeam = new Map();
										if (teamsData) {
											teamsData.forEach(player => {
												if (player.customFields && player.customFields[1]) {
													nameTeam.set(player.name, player.customFields[1].value);
												}
											});
										}
										
										console.log('Found', standing.length, 'players');
										console.log('Team mapping:', nameTeam);
										
										standing.forEach(player => {
											const li = document.createElement('li');
											const teamInfo = nameTeam.get(player) || '';
											li.textContent = player + (teamInfo ? ' - ' + teamInfo : '');
											list.appendChild(li);
										});
									}
									catch(error){
										console.error('Error:', error);
										alert('Failed to load standings. Check the link and try again.');
									}
								});
							}
						</script>
						<ol id="myList">
						</ol>
					</section>
			</div>

		<!-- Footer -->
			<footer id="footer">
				<div class="inner">
					<ul class="icons">
						<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
						<li><a href="#" class="icon brands fa-github"><span class="label">Github</span></a></li>
						<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
						<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
					</ul>
					<ul class="copyright">
						<li>&copy; Untitled</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.poptrox.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>